<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harare Traffic Watch</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places"></script>

    <style>
        /* Custom Scrollbar for the dashboard */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(31, 41, 55, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.8); border-radius: 3px; }
        
        /* Map container override */
        .map-container { width: 100%; height: 100vh; }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const HarareTrafficApp = () => {
            const mapRef = useRef(null);
            const [mapInstance, setMapInstance] = useState(null);
            const [isApiLoaded, setIsApiLoaded] = useState(false);
            const [loadError, setLoadError] = useState(false);

            // Traffic Data State
            const [travelTimes, setTravelTimes] = useState([
                { id: 1, name: "Chitungwiza", destination: "Chitungwiza, Zimbabwe", time: "-- min", status: "Waiting" },
                { id: 2, name: "Norton", destination: "Norton, Zimbabwe", time: "-- min", status: "Waiting" },
                { id: 3, name: "Ruwa", destination: "Ruwa, Zimbabwe", time: "-- min", status: "Waiting" },
                { id: 4, name: "Epworth", destination: "Epworth, Zimbabwe", time: "-- min", status: "Waiting" },
            ]);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [loading, setLoading] = useState(false);

            // Harare CBD Coordinates
            const center = { lat: -17.8252, lng: 31.0335 };

            // Initialize Map
            useEffect(() => {
                if (!window.google) {
                    // Check every 500ms if Google Maps script is ready
                    const interval = setInterval(() => {
                        if (window.google) {
                            setIsApiLoaded(true);
                            clearInterval(interval);
                        }
                    }, 500);
                    return () => clearInterval(interval);
                } else {
                    setIsApiLoaded(true);
                }
            }, []);

            // Setup Map Instance once API is loaded
            useEffect(() => {
                if (isApiLoaded && mapRef.current && !mapInstance) {
                    try {
                        const map = new window.google.maps.Map(mapRef.current, {
                            center: center,
                            zoom: 12,
                            disableDefaultUI: true, // Clean look
                            styles: [ // Dark Mode Map Style
                                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                            ]
                        });

                        // Add Traffic Layer (The Red/Green Lines)
                        const trafficLayer = new window.google.maps.TrafficLayer();
                        trafficLayer.setMap(map);

                        setMapInstance(map);
                    } catch (error) {
                        console.error("Error initializing map:", error);
                        setLoadError(true);
                    }
                }
            }, [isApiLoaded, mapRef]);

            // Function to fetch travel times
            const fetchTrafficData = useCallback(() => {
                if (!window.google || !window.google.maps) return;
                
                setLoading(true);
                const service = new window.google.maps.DistanceMatrixService();
                
                const destinations = travelTimes.map(t => t.destination);

                service.getDistanceMatrix(
                {
                    origins: ["Harare CBD, Zimbabwe"],
                    destinations: destinations,
                    travelMode: window.google.maps.TravelMode.DRIVING,
                    drivingOptions: {
                        departureTime: new Date(),
                        trafficModel: 'bestguess'
                    }
                },
                (response, status) => {
                    setLoading(false);
                    if (status === "OK" && response) {
                        const results = response.rows[0].elements;
                        
                        setTravelTimes(prev => prev.map((item, index) => {
                            const element = results[index];
                            const isOk = element && element.status === 'OK';
                            return {
                                ...item,
                                time: isOk ? element.duration_in_traffic.text : 'N/A',
                                status: isOk ? 'Live' : 'Unavailable'
                            };
                        }));
                        setLastUpdated(new Date().toLocaleTimeString());
                    } else {
                        console.error("Distance Matrix Error:", status);
                        alert("Could not fetch traffic data. Check API Key quotas.");
                    }
                });
            }, [travelTimes]);

            // Render Error State
            if (loadError) return (
                <div className="flex h-screen items-center justify-center text-red-500 bg-gray-900">
                    <div className="text-center">
                        <h1 className="text-2xl font-bold">Map Error</h1>
                        <p>Make sure your Google Maps API Key is valid and has "Maps JS API" enabled.</p>
                    </div>
                </div>
            );

            // Render Loading State
            if (!isApiLoaded) return (
                <div className="flex h-screen items-center justify-center bg-gray-900 text-white">
                    <div className="animate-pulse flex flex-col items-center">
                        <div className="h-8 w-8 bg-blue-500 rounded-full mb-4 animate-bounce"></div>
                        <p>Connecting to Satellites...</p>
                    </div>
                </div>
            );

            return (
                <div className="relative h-screen w-full">
                    
                    {/* Map Container */}
                    <div ref={mapRef} className="map-container" />

                    {/* Floating Dashboard (Glassmorphism) */}
                    <div className="absolute top-4 left-4 z-10 w-80 bg-gray-900/90 backdrop-blur-md text-white p-4 rounded-xl shadow-2xl border border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-lg font-bold text-red-500 flex items-center gap-2">
                                    {/* Warning Icon SVG */}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                                    HARARE WATCH
                                </h1>
                                <p className="text-xs text-gray-400">Live Congestion Feed</p>
                            </div>
                            
                            {/* Refresh Button */}
                            <button 
                                onClick={fetchTrafficData}
                                disabled={loading}
                                className={`p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                title="Refresh Traffic Times"
                            >
                                {/* Refresh Icon SVG */}
                                <svg className={loading ? "animate-spin" : ""} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                            </button>
                        </div>

                        {/* Travel Times List */}
                        <div className="space-y-3">
                            {travelTimes.map((item) => (
                                <div key={item.id} className="flex justify-between items-center bg-gray-800/50 p-3 rounded-lg border-l-4 border-red-500">
                                    <div>
                                        <p className="text-sm font-medium flex items-center gap-1">
                                            {/* Arrow Icon SVG */}
                                            <svg className="text-gray-400" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>
                                            CBD to {item.name}
                                        </p>
                                        <p className="text-[10px] text-gray-400 uppercase tracking-wider">{item.status}</p>
                                    </div>
                                    <div className={`text-xl font-bold ${item.time !== 'N/A' && item.time !== '-- min' ? 'text-green-400' : 'text-gray-500'}`}>
                                        {item.time}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {lastUpdated && (
                            <div className="text-center mt-3 text-xs text-gray-500">
                                Updated: {lastUpdated}
                            </div>
                        )}
                        
                        {!lastUpdated && (
                            <div className="text-center mt-3">
                                <button onClick={fetchTrafficData} className="text-xs text-blue-400 underline hover:text-blue-300">
                                    Load Traffic Times
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Report Button */}
                    <button 
                        className="absolute bottom-6 right-6 bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 z-20"
                        onClick={() => alert("Reporting feature coming soon!")}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 9v4"/><path d="M10.34 21H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8.66"/><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/></svg>
                        REPORT CLOG
                    </button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HarareTrafficApp />);
    </script>
</body>
</html>
