<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harare Traffic Command</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Custom UI Tweaks */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(31, 41, 55, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.8); border-radius: 3px; }
        
        .map-container { width: 100%; height: 100vh; z-index: 0; }
        
        .glass-panel {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_KEY = "8843db4128644049a678c9de38de9f10";

        const App = () => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const routeLayer = useRef(null);
            const trafficLayerRef = useRef(null);

            // State
            const [origin, setOrigin] = useState("");
            const [destination, setDestination] = useState("");
            const [mode, setMode] = useState("drive");
            const [avoidHighways, setAvoidHighways] = useState(false); // Back routes logic
            const [instructions, setInstructions] = useState([]);
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);

            // Default: Harare CBD
            const harareCBD = [-17.8252, 31.0335];

            // Helper: Format Time (Min -> Hr/Min)
            const formatTime = (seconds) => {
                const totalMin = Math.round(seconds / 60);
                if (totalMin < 60) return `${totalMin} min`;
                const hr = Math.floor(totalMin / 60);
                const min = totalMin % 60;
                return `${hr} hr ${min} min`;
            };

            // Initialize Map
            useEffect(() => {
                if (mapRef.current && !mapInstance.current) {
                    const map = L.map(mapRef.current, { zoomControl: false }).setView(harareCBD, 13);

                    // --- BASE LAYERS ---
                    const nightLayer = L.tileLayer(`https://maps.geoapify.com/v1/tile/dark-matter-brown/{z}/{x}/{y}.png?apiKey=${API_KEY}`, {
                        attribution: 'Geoapify', maxZoom: 20
                    });

                    const dayLayer = L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey=${API_KEY}`, {
                        attribution: 'Geoapify', maxZoom: 20
                    });

                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Esri', maxZoom: 19
                    });

                    // Set Default
                    nightLayer.addTo(map);

                    // --- TRAFFIC LAYER (Overlay) ---
                    const trafficFlow = L.tileLayer(`https://maps.geoapify.com/v1/tile/flow/{z}/{x}/{y}.png?apiKey=${API_KEY}`, {
                        maxZoom: 20, opacity: 1
                    });
                    trafficFlow.addTo(map);
                    trafficLayerRef.current = trafficFlow;

                    // --- LAYER CONTROL ---
                    const baseMaps = {
                        "Night Mode": nightLayer,
                        "Day View": dayLayer,
                        "Satellite": satelliteLayer
                    };
                    const overlayMaps = {
                        "Traffic Flow": trafficFlow
                    };

                    L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

                    mapInstance.current = map;
                }
            }, []);

            // 1. Get User Location
            const handleLocateMe = () => {
                if (!navigator.geolocation) return alert("Geolocation not supported");
                setLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        const coords = [latitude, longitude];
                        mapInstance.current.setView(coords, 15);
                        
                        // Custom Marker
                        L.circleMarker(coords, {
                            color: '#3b82f6',
                            fillColor: '#60a5fa',
                            fillOpacity: 0.8,
                            radius: 8
                        }).addTo(mapInstance.current).bindPopup("You are here").openPopup();

                        setOrigin(`${latitude},${longitude}`);
                        setLoading(false);
                        speak("Location found");
                    },
                    () => { alert("Could not get location"); setLoading(false); }
                );
            };

            // 2. Fetch Smart Route
            const getRoute = async () => {
                if (!origin || !destination) return alert("Please enter points");
                setLoading(true);

                try {
                    // Geocode Destination if needed
                    let destCoords = destination;
                    if (!destination.includes(",")) {
                        const geoRes = await fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(destination)}&filter=countrycode:zw&apiKey=${API_KEY}`);
                        const geoData = await geoRes.json();
                        if (geoData.features?.length > 0) {
                            const p = geoData.features[0].properties;
                            destCoords = `${p.lat},${p.lon}`;
                        } else {
                            alert("Destination not found");
                            setLoading(false);
                            return;
                        }
                    }

                    // Build URL with Back Route Logic
                    // avoid=highways forces the engine to find back roads
                    let url = `https://api.geoapify.com/v1/routing?waypoints=${origin}|${destCoords}&mode=${mode}&details=instruction_details&traffic=approximated&apiKey=${API_KEY}`;
                    
                    if (avoidHighways) {
                        url += "&avoid=highways";
                    }

                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.features?.length > 0) {
                        const route = data.features[0];

                        if (routeLayer.current) mapInstance.current.removeLayer(routeLayer.current);

                        // Route Style: Dashed if walking, Solid if driving
                        routeLayer.current = L.geoJSON(route, {
                            style: { 
                                color: mode === 'walk' ? '#3b82f6' : (avoidHighways ? '#A855F7' : '#10b981'), 
                                weight: 6,
                                opacity: 0.9,
                                dashArray: mode === 'walk' ? '10, 10' : null
                            }
                        }).addTo(mapInstance.current);

                        mapInstance.current.fitBounds(routeLayer.current.getBounds(), { padding: [50, 50] });

                        setInstructions(route.properties.legs[0].steps);
                        
                        const timeStr = formatTime(route.properties.time);
                        const distStr = (route.properties.distance / 1000).toFixed(1) + " km";
                        setSummary({ time: timeStr, dist: distStr });
                        
                        const type = avoidHighways ? "back road route" : "fastest route";
                        speak(`Found ${type}. Travel time is ${timeStr}`);
                    } else {
                        alert("No route found.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error calculating route.");
                }
                setLoading(false);
            };

            // 3. Voice
            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    window.speechSynthesis.speak(u);
                }
            };

            return (
                <div className="relative h-screen w-full flex flex-col md:flex-row">
                    
                    {/* Control Panel */}
                    <div className="order-2 md:order-1 glass-panel w-full md:w-96 p-4 flex flex-col h-[55%] md:h-full z-20 shadow-2xl relative">
                        <div className="mb-3">
                            <h1 className="text-xl font-bold text-red-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
                                HARARE NAV
                            </h1>
                        </div>

                        {/* Input Area */}
                        <div className="space-y-2 mb-3">
                            <div className="flex gap-2">
                                <input 
                                    className="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm focus:border-blue-500 outline-none"
                                    placeholder="Start (Click My Location)"
                                    value={origin}
                                    onChange={(e) => setOrigin(e.target.value)}
                                />
                                <button onClick={handleLocateMe} className="bg-blue-600 p-2 rounded text-white" title="Locate Me">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                                </button>
                            </div>

                            <input 
                                className="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm focus:border-blue-500 outline-none"
                                placeholder="Destination (e.g. Borrowdale)"
                                value={destination}
                                onChange={(e) => setDestination(e.target.value)}
                            />

                            {/* Options */}
                            <div className="flex items-center justify-between bg-gray-800 p-2 rounded">
                                <div className="flex gap-2">
                                    <button onClick={() => setMode('drive')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'drive' ? 'bg-green-600' : 'bg-gray-700'}`}>Car</button>
                                    <button onClick={() => setMode('walk')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'walk' ? 'bg-blue-600' : 'bg-gray-700'}`}>Walk</button>
                                </div>
                                
                                {/* Back Routes Toggle */}
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-gray-400">Back Rds</span>
                                    <input 
                                        type="checkbox" 
                                        checked={avoidHighways}
                                        onChange={() => setAvoidHighways(!avoidHighways)}
                                        className="w-4 h-4 accent-purple-500"
                                    />
                                </div>
                            </div>

                            <button 
                                onClick={getRoute} 
                                disabled={loading}
                                className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold p-2 rounded shadow transition"
                            >
                                {loading ? "Calculating..." : "GO"}
                            </button>
                        </div>

                        {/* Summary Card */}
                        {summary && (
                            <div className={`p-3 rounded-lg border-l-4 mb-2 flex justify-between items-center ${avoidHighways ? 'bg-purple-900/50 border-purple-500' : 'bg-green-900/50 border-green-500'}`}>
                                <div>
                                    <p className="text-xl font-bold">{summary.time}</p>
                                    <p className="text-xs text-gray-300">{summary.dist} â€¢ {avoidHighways ? "Back Routes" : "Standard"}</p>
                                </div>
                                <span className="text-2xl">ðŸš—</span>
                            </div>
                        )}

                        {/* Instructions */}
                        <div className="flex-grow overflow-y-auto space-y-1 pr-1">
                            {instructions.map((step, idx) => (
                                <div key={idx} className="flex items-start gap-3 p-3 bg-gray-800/40 rounded hover:bg-gray-700 cursor-pointer" onClick={() => speak(step.instruction.text)}>
                                    <span className="text-gray-400 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                                    </span>
                                    <div className="text-sm">
                                        <p>{step.instruction.text}</p>
                                        <p className="text-xs text-gray-500">{step.distance}m</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Map Area */}
                    <div className="order-1 md:order-2 flex-grow relative h-[45%] md:h-full">
                        <div ref={mapRef} className="map-container h-full w-full" />
                        
                        {/* Traffic Legend */}
                        <div className="absolute top-16 right-2 md:top-4 md:right-14 bg-gray-900/90 p-2 rounded text-[10px] md:text-xs z-[1000] border border-gray-600 shadow-xl">
                            <h4 className="font-bold mb-1 border-b border-gray-700 pb-1">Traffic Flow</h4>
                            <div className="flex items-center gap-2 mb-1"><div className="w-4 h-1 bg-green-500 rounded"></div> Fast</div>
                            <div className="flex items-center gap-2 mb-1"><div className="w-4 h-1 bg-orange-500 rounded"></div> Moderate</div>
                            <div className="flex items-center gap-2 mb-1"><div className="w-4 h-1 bg-red-600 rounded"></div> Slow / Jam</div>
                            <div className="flex items-center gap-2"><div className="w-4 h-1 bg-gray-500 rounded"></div> No Data</div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
